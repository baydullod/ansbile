---
- name: Apply the latest kernel updates
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Update the package list
      ansible.builtin.apt:
        update_cache: yes

    - name: Upgrade all packages, including the latest kernel
      ansible.builtin.apt:
        name: '*'
        state: latest

    - name: Ensure the latest kernel is installed
      ansible.builtin.shell: |
        dpkg -l | grep linux-image | grep ii | sort -V | tail -n 1 | awk '{print $2}'
      register: latest_kernel
      changed_when: false

    - name: Set GRUB to boot into the latest kernel by default
      ansible.builtin.replace:
        path: /etc/default/grub
        regexp: '^GRUB_DEFAULT=.*'
        replace: 'GRUB_DEFAULT="Advanced options for Ubuntu>Ubuntu, with Linux {{ latest_kernel.stdout }}"'
      notify: Update GRUB

    - name: Update GRUB configuration
      ansible.builtin.command: update-grub
      when: latest_kernel is defined
      notify: Reboot System

  handlers:
    - name: Update GRUB
      ansible.builtin.command: update-grub

    - name: Reboot System
      ansible.builtin.reboot:
        reboot_timeout: 600

    - name: Verify the running kernel after reboot
      ansible.builtin.shell: uname -r
      register: running_kernel

    - name: Ensure the system is running the latest kernel
      ansible.builtin.debug:
        msg: "The system is now running the latest kernel version: {{ running_kernel.stdout }}."
      when: latest_kernel.stdout in running_kernel.stdout

    - name: Fail if the system is not running the latest kernel
      ansible.builtin.fail:
        msg: "Kernel update failed. The system is not running the latest kernel version: {{ latest_kernel.stdout }}."
      when: latest_kernel.stdout not in running_kernel.stdout
